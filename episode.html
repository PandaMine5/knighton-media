<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title></title>
    <meta name="description" content="Watch all 50+ Nexo Knights episodes in English, Ukrainian, German, Romanian at Knighton Media!" />
    <meta property="og:type" content="video.episode" />
  
    <link rel="icon" type="image/png" href="assets/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Knighton Media" />

    <link rel="preconnect" href="https://archive.org" crossorigin>
    <link rel="preconnect" href="https://pub-32d873d5659e44dd9560a0e752ca2122.r2.dev" crossorigin>
    <link rel="preload" href="js/episode.js" as="script" />
    <link rel="stylesheet" href="css/reset.css" />
    <link rel="stylesheet" href="css/episode.css" />
    <link rel="stylesheet" href="css/index.css" />
    <style>
        .player {
            display: none;
            position: relative;
            width: 100%;
        }

        #video {
            display: block;
            width: 100%;
            aspect-ratio: 16 / 9.5;
            object-fit: cover;

            &.fullscreen {
                max-height: none;
                height: 100vh;
                object-fit: contain;
                background-color: black;
            }
        }

        .player__overlay {
            position: absolute;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            inset: 0;
            transition: opacity 0.3s ease-in-out;
            opacity: 1;

            &.hidden {
                opacity: 0;
                pointer-events: none;
            }
        }

        .player__back-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 8px;
            left: 14px;
            filter: drop-shadow(0 0 2px hsl(0 0% 0% / 0.85));
            padding: 6px;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
            z-index: 5;
            pointer-events: auto !important;

            &.hidden {
                opacity: 0;
                pointer-events: none;
            }
        }

        .player__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px;
            padding-top: 8px;
            z-index: 2;
        }

        .player__meta {
            text-align: center;
            flex: 1;
        }

        .player__meta-title {
            font-size: clamp(0.75rem, 3.5vw, 0.875rem);
            font-weight: 500;
            text-shadow: 0 0 2px hsl(0 0% 0% / 0.65);
        }

        .player__meta-episode {
            font-size: clamp(0.625rem, 3vw, 0.75rem);
            font-weight: 500;
            opacity: 0.75;
            margin-top: 2px;
            text-shadow: 0 0 2px hsl(0 0% 0% / 0.65);
        }

        .player__controls--center {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player__button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: clamp(44px, 4vw, 56px);
            aspect-ratio: 1;
            z-index: 2;
        }

        .player__icon--play {
            width: 20px;
            height: 20px;
            filter: drop-shadow(0 0 3px hsl(0 0% 0% / 0.85));
        }

        .player__button--skip {
            position: absolute;
            width: 35%;
            height: 100%;
            background: hsl(0 0% 100% / 0);

            &.left {
                left: 0%;
            }

            &.right {
                right: 0%;
            }
        }

        .player__controls--bottom {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 0 14px;
            padding-bottom: 8px;
            z-index: 2;
        }

        .player__time-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.125rem;
        }

        .player__time {
            font-size: 10px;
            font-weight: 600;
            color: white;
            text-shadow: 0px 1px 1px hsl(0 0% 0% / 0.5);
        }

        .player__time--end {
            opacity: 0.75;
        }

        .player__seekbar {
            position: relative;
            width: 100%;
            margin-bottom: 0.25rem;
        }

        .player__seekbar-track,
        .player__seekbar-fill,
        .player__seekbar-buffered {
            position: absolute;
            inset: 0;
            border-radius: 100vmax;
            height: 3px;
        }

        .player__seekbar-track {
            background: hsl(0 0% 100% / 0.25);
            backdrop-filter: blur(1px);
        }

        .player__seekbar-fill {
            background: white;
            width: 0%;
        }

        .player__seekbar-buffered {
            background: hsl(0 0% 100% / 0.32);
            width: 0%;
        }

        .player__seekbar input[type="range"] {
            all: unset;
            position: absolute;
            width: 100%;
            height: 100%;
            background: transparent;
            margin: 0;
            z-index: 2;
        }

        .player__seekbar input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            border: none;
            width: 14px;
            aspect-ratio: 1;
            border-radius: 50%;
            background: white;
            transform: translateY(1px);
            filter: drop-shadow(-1px 0px 1px hsl(0 0% 0% / 0.15));
        }

        .player__seekbar input[type="range"]::-moz-range-thumb {
            appearance: none;
            border: none;
            width: 14px;
            aspect-ratio: 1;
            border-radius: 50%;
            background: white;
            transform: translateY(1px);
            filter: drop-shadow(-1px 0px 1px hsl(0 0% 0% / 0.15));
        }

        .player__toolbar {
            display: flex;
            justify-content: space-between;
        }

        .player__toolbar-group {
            display: flex;
            align-items: center;
            gap: 1rem;
            border-radius: 100vmax;
            background: hsl(0 0% 100% / 0.1);
            backdrop-filter: blur(1px);
                box-shadow:
            1px 1px hsl(0 0% 100% / 0.3) inset,
            -1px -1px hsl(0 0% 100% / 0.15) inset,
            0 0 3px hsl(0 0% 0% / 0.5);
            padding: clamp(6px, 2vw, 8px) clamp(8px, 2vw, 12px);
        }

        .player__menu {
            display: none;
            flex-direction: column;
            width: 120px;
            max-height: 100px;
            position: absolute;
            bottom: 56px;
            right: 14px;
            background: hsl(0 0% 10%);
            border: 1px solid hsl(0 0% 100% / 0.1);
            border-radius: 8px;
            overflow-y: auto;
            box-shadow: 2px 2px 7px rgba(0, 0, 0, 0.2);
            z-index: 3;

            &.visible {
                display: flex;
            }
        }

        .player__menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-size: 11px;
            padding: 8px 14px;

            &:hover {
                background: hsl(0 0% 17%);
            }
        }

        .player__menu-item+.player__menu-item {
            border-top: 1px solid hsl(0 0% 100% / 0.06);
        }

        .player__menu-label {
            font-size: 11px;
        }

        .player__menu--sub {
            button {
                font-size: 11px;
                text-align: left;
                color: hsl(0 0% 75%);
                padding: 8px 14px;

                &:hover {
                    background: hsl(0 0% 17%);
                }

                &.active {
                    color: hsl(0 0% 100%);
                    background: hsl(0 0% 10%);
                }
            }
        }

        .player__menu--back-btn {
            display: flex;
            align-items: center;
            gap: 0.125rem;
            cursor: pointer;
        }

        ideo::cue {
            display: inline-block;
            font-size: 0.625rem;
            font-weight: 500;
            background: hsl(0 0% 0% / 0.5);
            padding: 2px;
        }
        
        #subtitles {
  position: absolute;
  bottom: 20%;
  left: 50%;
  transform: translateX(-50%);    
  padding: 0;
  opacity: 0;
  pointer-events: none;
  
  &.visible {
   display: inline-block;
    font-size: 0.625rem;
    font-weight: 500;
    background: hsl(0 0% 0% / 0.4);
    padding: 2px;
    white-space: normal;
    word-break: keep-all;
    color: white;
    opacity: 1;
  }
}
    </style>
</head>

<body>
	<svg xmlns="http://www.w3.org/2000/svg" style="display: none" aria-hidden="true">>
		<symbol id="icon-discord" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"></path></symbol>
		<symbol id="icon-github" viewBox="0 0 98 96" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z"/></symbol>
		<symbol id="icon-curseforge" viewBox="0 0 24 24" fill="currentColor" stroke-width="1"><path d="M18.326 9.2145S23.2261 8.4418 24 6.1882h-7.5066V4.4H0l2.0318 2.3576V9.173s5.1267 -0.2665 7.1098 1.2372c2.7146 2.516 -3.053 5.917 -3.053 5.917L5.0995 19.6c1.5465 -1.4726 4.494 -3.3775 9.8983 -3.2857 -2.0565 0.65 -4.1245 1.6651 -5.7344 3.2857h10.9248l-1.0288 -3.2726s-7.918 -4.6688 -0.8336 -7.1127z"></path></symbol>
		<symbol id="icon-chevron-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m14 18-6-6 6-6"/></symbol>
		<symbol id="icon-chevron-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></symbol>
		<symbol id="icon-star" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"/></symbol>
		<symbol id="icon-play" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor"><path d="M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z"/></symbol>
		<symbol id="icon-stop" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor"><path d="M5 2h14a3 3 0 0 1 3 3v14a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V5a3 3 0 0 1 3-3Z"/></symbol>
		<symbol id="icon-pause" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor"><rect x="14" y="3" width="5" height="18" rx="1"/><rect x="5" y="3" width="5" height="18" rx="1"/></symbol>
		<symbol id="icon-cog" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 10.27 7 3.34m4 10.39-4 6.93M12 22v-2m0-18v2m2 8h8m-5 8.66-1-1.73m1-15.59-1 1.73M2 12h2m16.66 5-1.73-1m1.73-9-1.73 1M3.34 17l1.73-1M3.34 7l1.73 1"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="12" r="8"/></symbol>
		<symbol id="icon-volume-off" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 9a5 5 0 0 1 .95 2.293"/><path d="M19.364 5.636a9 9 0 0 1 1.889 9.96"/><path d="m2 2 20 20"/><path d="m7 7-.587.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298V11"/><path d="M9.828 4.172A.686.686 0 0 1 11 4.657v.686"/></symbol>
		<symbol id="icon-volume-min" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z"/><path d="M16 9a5 5 0 0 1 0 6"/></symbol>
		<symbol id="icon-volume-max" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z"/><path d="M16 9a5 5 0 0 1 0 6"/><path d="M19.364 18.364a9 9 0 0 0 0-12.728"/></symbol>
		<symbol id="icon-captions" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="14" x="3" y="5" rx="2" ry="2"/><path d="M7 15h4M15 15h2M7 11h2M13 11h4"/></symbol>
		<symbol id="icon-minimize" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m14 10 7-7M20 10h-6V4M3 21l7-7M4 14h6v6"/></symbol>
		<symbol id="icon-maximize" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6M21 3l-7 7M3 21l7-7M9 21H3v-6"/></symbol>
		<symbol id="icon-rewind-cw" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></symbol>
		<symbol id="icon-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="m19 12-7 7-7-7"/></symbol>
	</svg>

    <button id="backButton" class="player__back-btn">
        <svg class="svg-icon"><use href="#icon-chevron-left"></use></svg>
    </button>

    <!--<div class="subtitles">CLAY: It’s like, a blur.</div>
            -->
    <div id="player" class="player">
        <video id="video" preload="metadata" playsinline></video>
        <div class="player__overlay">
            <div class="player__header">
                <div class="player__meta">
                    <div class="player__meta-title"> </div>
                    <div class="player__meta-episode"> </div>
                </div>
            </div>
            <div class="player__controls--center">
                <button id="rewindButton" class="player__button--skip left"></button>
                <button id="playButtonTriangle" class="player__button">
                    <svg class="player__icon--play"><use id="iconPlayPause" href="#icon-play"></use></svg>
                </button>
                <button id="forwardButton" class="player__button--skip right"></button>
            </div>
            <div id="subtitles"></div>
            <div class="player__controls--bottom">
                <div class="player__time-row">
                    <div id="currentTime" class="player__time">0:00</div>
                    <div id="remainingTime" class="player__time player__time--end">0:00</div>
                </div>
                <div class="player__seekbar">
                    <div class="player__seekbar-track">
                        <div id="seekBuffered" class="player__seekbar-buffered"></div>
                        <div id="seekFill" class="player__seekbar-fill"></div>
                    </div>
                    <input id="seekbar-slider" type="range" value="0" step="1" min="0" max="1000" />
                </div>
                <div style="display:non" class="player__toolbar">
                    <div class="player__toolbar-group">
                        <div id="playButtonTriangleToolbar">
                            <svg class="svg-icon">
                                <use id="iconPlayPauseToolbar" href="#icon-play"></use>
                            </svg>
                        </div>
                        <div id="volumeButtonToolbar">
                            <svg class="svg-icon">
                                <use href="#icon-volume-max"></use>
                            </svg>
                        </div>
                    </div>
                    <div class="player__toolbar-group">
                        <div id="mediaButtonToolbar">
                            <svg class="svg-icon">
                                <use href="#icon-captions"></use>
                            </svg>
                        </div>
                        <div id="settingsButtonToolbar">
                            <svg class="svg-icon">
                                <use href="#icon-cog"></use>
                            </svg>
                        </div>
                        <div id="fullscreenButtonToolbar">
                            <svg class="svg-icon">
                                <use href="#icon-maximize"></use>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="settingsMenu" class="player__menu"></div>
    </div>
    <script src="js/lib/hls.js"></script>
    <script src="js/episode.js" type="module" defer></script>
    <script type="module">
        import { ep } from "./js/episode.js";

        const ratingOn = false;

        const getID = document.getElementById.bind(document);
        const getSelector = document.querySelector.bind(document);

        const video = getID("video");
        const player = getID("player");
        const overlay = getSelector(".player__overlay");
        const backButton = getID("backButton");
        const playButton = getID("playButton");
        const playButtonTriangle = [getID("playButtonTriangle"), getID("playButtonTriangleToolbar")];
        const playIcon = [getID("iconPlayPause"), getID("iconPlayPauseToolbar")];
        const rewindButton = getID("rewindButton");
        const forwardButton = getID("forwardButton");

        const playerTitle = getSelector(".player__meta-title");
        const playerEpisode = getSelector(".player__meta-episode");

        const volumeButton = getID("volumeButtonToolbar");
        const fullscreenButton = getID("fullscreenButtonToolbar");
        const settingsButton = getID("settingsButtonToolbar");
        const settingsMenu = getID("settingsMenu");
        const mediaButton = getID("mediaButtonToolbar");
        const seekbarSlider = getID("seekbar-slider");
        const seekFill = getID("seekFill");
        const seekBuffered = getID("seekBuffered");
        const currentTime = getID("currentTime");
        const remainingTime = getID("remainingTime");

        const capitalizeFirstLetter = str => {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

    if (window.self !== window.top) {
      window.stop();
      document.documentElement.innerHTML = `<div>Not Found (Error: Fake Website)<div><br /><div>Current URL: ${window.self.location}</div><br /><div>Knighton Media URL: pandamine5.github.io/knighton-media</div><br /><div>Contact PandaMine5 by discord: pandamine5x</div>`;      
    }
    
        video.poster = `assets/episode-images/${ep.thumbnail}`;


    const subtitlesDiv = document.getElementById("subtitles");
    let subtitles = [];
    
    fetch("../ep02/S01：E01 - The Book of Monsters (Pt. 1).English.srt")
      .then(response => response.text())
      .then(text => {
        subtitles = parseVTT(text);
      });
      
    function parseVTT(data) {
      const lines = data.split("\n");
      const cues = [];
      let i = 0;
      while (i < lines.length) {
        const line = lines[i].trim();
        if (line.includes("-->")) {
          const [start, end] = line.split("-->").map(s => s.trim());
          let text = "";
          i++;
          while (i < lines.length && lines[i].trim() !== "") {
            text += lines[i] + "\n";
            i++;
          }
          cues.push({
            start: toSeconds(start),
            end: toSeconds(end),
            text: text.trim()
          });
        }
        i++;
      }
      return cues;
    }

    function toSeconds(time) {
      const [hours, minutes, seconds] = time.split(":");
      return (
        parseFloat(hours) * 3600 +
        parseFloat(minutes) * 60 +
        parseFloat(seconds.replace(",", "."))
      );
    }

    video.addEventListener("timeupdate", () => {
  const current = video.currentTime;
  const cue = subtitles.find(c => current >= c.start && current <= c.end);
  if (cue) {
    subtitlesDiv.textContent = cue.text;
    subtitlesDiv.classList.add("visible");
  } else {
    subtitlesDiv.textContent = "";
    subtitlesDiv.classList.remove("visible");
  }
});

        let videoStarted = false;
        let skipMode = false;
        let skipTimeout;
        let hideControlsTimeout;
        
        
        const hls = new Hls({
            autoStartLoad: false, // Не трогати 
            enableWorker: true,
            maxBufferLength: 20,
            maxMaxBufferLength: 40,
            maxBufferSize: 60 * 1000 * 1000,
            liveSyncDurationCount: 3,
            maxFragLookUpTolerance: 0.2,

            fetchSetup: (context, initParams) => {
                const requestParams = { method: "GET", cache: "default", /*credentials: "omit" */};

                return new Request(context.url, { ...requestParams, ...initParams });
            }
        });

        if (ep.m3u8_link && Hls.isSupported()) {
            hls.loadSource("https://pub-32d873d5659e44dd9560a0e752ca2122.r2.dev/" + ep.m3u8_link);
            //hls.loadSource(ep.m3u8_link);
            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                video.play().catch(() => { });
            });

            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                const levels = hls.levels.map((lvl, i) => ({
                    index: i,
                    height: lvl.height,
                    label: `${lvl.height}p`,
                }));
                window.qualityLevels = levels;
            });
        }

        else if (ep.m3u8_link && video.canPlayType("application/vnd.apple.mpegurl")) {
            video.src = ep.m3u8_link;
            video.play().catch(() => { });
        }

        else if (ep.mp4_link) {
            video.src = encodeURI(atob("aHR0cHM6Ly9hcmNoaXZlLm9yZy9kb3dubG9hZC9rbmlnaHRvbi1tZWRpYS1uay8") + ep.mp4_link);
        }

        video.addEventListener("loadedmetadata", () => {
            remainingTime.textContent = formatTime(video.duration);
        });


        document.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
               e.preventDefault();
               startVideo();
            }
            
            if (videoStarted === true) {
	            if (e.key === " ") {
	               e.preventDefault();
	               togglePlay();
	            }  
	
	            if (e.key === "f") {
            	   e.preventDefault();
	               toggleFullscreen();
	            }
	            
/*	            if (e.key === "ArrowRight") {
            	   e.preventDefault();
	               video.currentTime = Math.min(video.duration, video.currentTime + 5);
	            }
	
	            if (e.key === "ArrowLeft") {
            	   e.preventDefault();
	               video.currentTime = Math.max(0, video.currentTime - 5);
	            }  

                if (e.key === "ArrowUp") {
	               video.volume = Math.min(0, video.volume + 0.1);
	            }   

                if (e.key === "ArrowDown") {
	               video.volume = Math.max(1, video.volume - 0.1);
	            }*/
            } 
        });   


        playerTitle.textContent = ep.title;
        playerEpisode.textContent = `${capitalizeFirstLetter(ep.type)} ${ep.number}`;


        backButton.addEventListener("click", () => {
            history.back();
        });

        playButton.addEventListener("click", () => {
           startVideo();
        });

        fullscreenButton.addEventListener("click", (e) => {
            e.stopPropagation();
            toggleFullscreen();
        });

        document.addEventListener("fullscreenchange", () => {
            fullscreenButton.querySelector("use").setAttribute("href", document.fullscreenElement ? "#icon-minimize" : "#icon-maximize");
        });
        
        function startVideo() {
            if (hls) hls.startLoad();

            player.style.display = "block";
            mainImageWrapper.style.display = "none";
            showOverlay();
        } 

        function togglePlay() {
            if (video.paused) {
                video.play().catch(() => { });
                if (hls) hls.startLoad(video.currentTime);
            } else {
                video.pause(); 
                if (hls) hls.stopLoad();
            }
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                player.requestFullscreen().catch(console.error);
                video.classList.add("fullscreen");
            } else {
                document.exitFullscreen();
                video.classList.remove("fullscreen");
            }
        }

        function formatTime(time) {
            let minutes = String(Math.floor(time / 60));
            let seconds = String(Math.floor(time % 60));
            return `${minutes}:${seconds.padStart(2, "0")}`;
        }

        function updateTimeline() {
            if (video.duration) {
                const progress = (video.currentTime / video.duration) * seekbarSlider.max;
                seekbarSlider.value = progress;
                seekFill.style.width = `${progress / 10}%`;
                currentTime.textContent = formatTime(video.currentTime);
                if (video.buffered.length > 0) {
                    const bufferedEnd = video.buffered.end(video.buffered.length - 1);
                    const bufferedPercent = (bufferedEnd / video.duration) * 100;
                    seekBuffered.style.width = `${bufferedPercent}%`;
                }
            }
        }

        seekbarSlider.addEventListener("input", () => {
            if (video.duration) {
                video.currentTime = (seekbarSlider.value / seekbarSlider.max) * video.duration;
                updateTimeline();
            }
        });
        
        playButtonTriangle.forEach((b) => b.addEventListener("click", togglePlay));
        video.addEventListener("play", () => playIcon.forEach((i) => i.setAttribute("href", "#icon-pause")));
        video.addEventListener("pause", () => playIcon.forEach((i) => i.setAttribute("href", "#icon-play")));
        video.addEventListener("timeupdate", updateTimeline);
        video.addEventListener("click", togglePlay);
  
        // +5s
        forwardButton.addEventListener("click", () => {
            if (!skipMode) return;
            video.currentTime = Math.min(video.duration, video.currentTime + 5);
            updateTimeline();
            clearTimeout(skipTimeout);
            skipTimeout = setTimeout(() => {
                skipMode = false;
            }, 500);
        });
        
        forwardButton.addEventListener("dblclick", () => {
            skipMode = true;
            video.currentTime = Math.min(video.duration, video.currentTime + 5);
            updateTimeline();
            clearTimeout(skipTimeout);
            skipTimeout = setTimeout(() => { 
                skipMode = false 
            }, 500);
        });
        
        
        // -5s
        rewindButton.addEventListener("click", () => {
            if (!skipMode) return;
            video.currentTime = Math.max(0, video.currentTime - 5);
            updateTimeline();
            clearTimeout(skipTimeout);
            skipTimeout = setTimeout(() => {
                skipMode = false;
            }, 500);
        });
        
        rewindButton.addEventListener("dblclick", () => {
            skipMode = true;
            video.currentTime = Math.max(0, video.currentTime - 5);
            updateTimeline();
            clearTimeout(skipTimeout);
            skipTimeout = setTimeout(() => {
                skipMode = false;
            }, 500);
        });
        

        volumeButton.addEventListener("click", () => {
            video.muted = !video.muted;
            volumeButton.querySelector("use").setAttribute("href", video.muted ? "#icon-volume-off" : "#icon-volume-max");
        });

        function createMenu({ title, items, isSub = false, onBack }) {
            settingsMenu.innerHTML = "";
            settingsMenu.classList.toggle("player__menu--sub", isSub);
            settingsMenu.classList.add("visible");
            if (isSub) {
                const back = document.createElement("button");
                back.className = "player__menu--back-btn";
                back.innerHTML = `<svg class="svg-icon"><use href="#icon-chevron-left"></use></svg>Back`;
                back.addEventListener("click", (e) => {
                    e.stopPropagation();
                    onBack();
                });
                settingsMenu.appendChild(back);
            }
            
            items.forEach((item) => {
                if (item.type === "submenu") {
                    const div = document.createElement("div");
                    div.className = "player__menu-item";
                    div.innerHTML = `<div class="player__menu-label">${item.label}</div><svg class="svg-icon" style="opacity: 0.6"><use href="#icon-chevron-right"></use></svg>`;
                    div.addEventListener("click", (e) => {
                        e.stopPropagation();
                        item.open();
                    });
                    settingsMenu.appendChild(div);
                } else {
                    const btn =
                        document.createElement("button");
                    btn.textContent = item.label;
                    if (item.active) btn.classList.add("active");
                    btn.addEventListener("click", (e) => {
                        e.stopPropagation();
                        item.action();
                        if (!item.stayOpen) {
                            return onBack();
                        }
                    });
                    settingsMenu.appendChild(btn);
                }
            });
        }

        function showSettingsMenu() {
            createMenu({
                isSub: false,
                items: [
                    {
                        type: "submenu",
                        label: "Quality",
                        open: () => openSubMenu("quality")
                    },
                    {
                        type: "submenu",
                        label: "Speed",
                        open: () => openSubMenu("speed")
                    },/*
      {
         type: "submenu",
         label: "Effects",
         open: () => openSubMenu("effects")
      }*/
                ]
            });
        }

        function
            showMediaMenu() {
            createMenu({
                isSub: false,
                items: [{
                    type: "submenu",
                    label: "Languages",
                    open: () =>
                        openMediaSubMenu("language")
                },
		        {
	   	         type: "submenu",
	   	         label: "Subtitles",
	   	         open: () => openMediaSubMenu("subtitles"),
		        }
                ],
            });
        }

        function openSubMenu(type) {
            if (type ===
                "quality") {
                const items = (window.qualityLevels || []).map((lvl) => ({
                    label: lvl.label,
                    active: hls.currentLevel === lvl.index,
                    action: () => {
                        hls.currentLevel = lvl.index;
                    },
                }));
                createMenu({
                    isSub: true,
                    onBack: showSettingsMenu,
                    items,
                });
                return;
            }
            const data = {
                quality: [],
                speed: [0.25, 0.5, 1, 1.5, 2, 4, 8, 16],
                effects: ["Brightness", "Saturation", "Contrast", "Sepia"],
            }[type];

            const items = data.map((value) => {
                const label = type === "speed" ? `${value}x` : value;
                const isActive = (type === "speed" && video.playbackRate === value) || (type === "effects" && value === "Sharp Image");
                return {
                    label,
                    active: isActive,
                    action: () => {
                        if (type === "speed") video.playbackRate = value;
                    },
                };
            });
            createMenu({
                isSub: true,
                onBack: showSettingsMenu,
                items,
            });
        }

        // Не трогати 
        hls.on(Hls.Events.AUDIO_TRACKS_UPDATED, () => {
            if (hls.audioTracks && hls.audioTracks.length > 0) {
                const trackIndex = hls.audioTracks.findIndex(track => track.lang === localStorage.getItem("lastAudioTrack"));
                if (trackIndex !== -1) {
                    hls.audioTrack = trackIndex;
                }
            }
        });

        function openMediaSubMenu(type) {
            let items = [];

            if (type === "language" && hls.audioTracks) {
                items = hls.audioTracks.map((track, index) => ({
                    label: track.name,
                    active: index === hls.audioTrack,
                    action: () => {
                        hls.audioTrack = index;
                        localStorage.setItem("lastAudioTrack", hls.audioTracks[index].lang);
                    }
                }));
            }
            if (type === "subtitles") {
                items = hls.subtitleTracks.map((track, index) => ({
                   label: track.name,
                   active: index === hls.subtitleTrack,
                   action: () => {
                      hls.subtitleTrack = index;
                   }
                }));
            }

            createMenu({
                isSub: true,
                onBack: showMediaMenu,
                items
            });
        }


        settingsButton.addEventListener("click", (e) => {
            e.stopPropagation();
            settingsMenu.classList.contains("visible") ? settingsMenu.classList.remove("visible") : showSettingsMenu();
        });
        
        mediaButton.addEventListener("click", (e) => {
            e.stopPropagation();
            settingsMenu.classList.contains("visible") ? settingsMenu.classList.remove("visible") : showMediaMenu();
        });
        
        document.addEventListener("click", (e) => {
            if (settingsMenu.classList.contains("visible") &&
                !settingsMenu.contains(e.target) && e.target !== settingsButton && e.target !== mediaButton) {
                settingsMenu.classList.remove("visible");
            }
        });


        function showOverlay() {
            overlay.classList.remove("hidden");
            backButton.classList.remove("hidden");

            clearTimeout(hideControlsTimeout);

            if (!video.paused) {
                hideControlsTimeout = setTimeout(hideOverlay, 3000);
            }
        }

        function hideOverlay() {
            overlay.classList.add("hidden");
            backButton.classList.add("hidden");
        }

        ["mousemove", "click", "touchstart"].forEach((event) => {
            player.addEventListener(event, showOverlay);
        });

        player.addEventListener("mouseleave", () => {
            if (!video.paused || video.paused) {
                overlay.classList.add("hidden");
                backButton.classList.add("hidden");
            }
        });

        document.addEventListener("click", (e) => {
            const clickOutside = !player.contains(e.target);

            if (!video.paused && clickOutside) {
                overlay.classList.add("hidden");
            }
        });

        video.addEventListener("play", showOverlay);
        video.addEventListener("pause", showOverlay);
    </script>
</body>

</html>
